<!DOCTYPE html>
<html>
<meta name="viewport" content="width=device-width, initial-scale=1">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>Sun</title>
<script src="suncalc.js"></script>
<style type="text/css">
html, body { width:100%; height:100%; overflow: hidden;} /* just to be sure these are full screen*/
h1 { text-align: center; }
#myCanvas { display: block;  margin: 0 auto; }
#timeslider { width:90%; margin: 0 auto; display: block;
</style>
</head>
<script>

var deg  = 180 / Math.PI;
var radius = 200;

var timeStringOptions = { hour: '2-digit', minute: '2-digit' };

function polar(r, al, az, north)
{
    return { x: -r * Math.sin(az+north) * Math.cos(al), y:r * Math.cos(az+north) * Math.cos(al)};
}

function DrawLine(context, date, lat, lng, north, color, align)
{
    var res = SunCalc.getPosition(date, lat, lng)
    var p = polar(radius, res.altitude, res.azimuth, north);
    context.beginPath();
    context.strokeStyle = color;
    context.lineWidth=5;
    context.moveTo(0,0); 
    context.lineTo(p.x,p.y); 
    context.moveTo(p.x,p.y); 

    if (align)
    {
        context.textAlign = align;
        context.fillText("  "+ date.toLocaleTimeString(navigator.language, timeStringOptions)+"  ",p.x,p.y);
    }
    
    context.stroke(); 
}

function SunPath(context, date, lat, lng, north, color, width)
{    
    var times = SunCalc.getTimes(date, lat, lng);
       
    context.beginPath();
    context.strokeStyle = color;
    context.lineWidth=width;
    for(var i=0;i<=50;i++)
    {
        var t = (i/50.0);
        time = times.sunset * t + times.sunrise * (1.0 - t);

        var res = SunCalc.getPosition(time, lat, lng)

        var p = polar(radius, res.altitude, res.azimuth, north);
        context.lineTo(p.x,p.y); 
    }
    context.stroke();     
}

Date.prototype.addDays = function(days) {
  var dat = new Date(this.valueOf());
  dat.setDate(dat.getDate() + days);
  return dat;
}

function DrawHemisphere(context, lat, lng, north)
{
    var date = new Date();

    var res = SunCalc.getPosition(date, lat, lng)
    
    var times = SunCalc.getTimes(date, lat, lng);
       
    SunPath(context, date, lat, lng, north, 'rgb(255, 219, 26)',5)
   
    DrawLine(context, times.sunrise, lat, lng, north, 'rgb(255, 219, 26)', "left") 
    DrawLine(context, times.sunset, lat, lng, north, 'rgb(255, 143, 102)', "right")

    DrawLine(context, date, lat, lng, north, 'rgb(255, 174, 26)')

    var FirstJanuary = new Date(new Date().getFullYear(), 0, 1);    
    SunPath(context, FirstJanuary.addDays(171.6), lat, lng, north, '#000000', .5)
    SunPath(context, FirstJanuary.addDays(355.1), lat, lng, north, '#000000', .5)
}

function DrawCompass(context, north)
{
    context.beginPath();
    context.lineWidth=2.5;
    context.arc(0,0,radius,0,2*Math.PI);
    context.stroke(); 

    context.beginPath();
    context.setLineDash([1, 2]);
    context.font="15px sans-serif"
    context.textAlign = "center";    
    var dirs = ["S","W", "N","E"]
    for(var i=0;i<4;i++)
    {
        context.moveTo(0,0); 
        
        p = polar(radius, 0, (i*90)/deg, north)                
        context.lineTo(p.x,p.y); 
        
        p = polar(radius*1.05, 0, (i*90)/deg, north)                
        context.fillText(dirs[i],p.x,p.y);
    }               
    context.stroke(); 

    context.setLineDash([]);
}

function DrawAll(context, canvas, gpsCoords, north)
{
    var scale = canvas.height/500;

    //set viewport
    context.setTransform(1, 0, 0, 1, 0, 0);        
    context.clearRect(0, 0, canvas.width, canvas.height);        
    context.translate(canvas.width * 0.5, canvas.height * 0.5);    
    context.scale(scale,scale);   

    DrawCompass(context, north);    
    DrawHemisphere(context, gpsCoords.latitude, gpsCoords.longitude, north);
}

function init()
{
    window.addEventListener('resize', resizeCanvasAndDraw, false);
    
    var myCanvas = document.getElementById("myCanvas");
    var context = myCanvas.getContext('2d');
    
    var gpsCoords = { latitude:0, longitude:0};

    function resizeCanvasAndDraw() 
    {
        if (myCanvas.width != window.innerWidth || myCanvas.height != window.innerHeight)
        {
            if (window.innerWidth>window.innerHeight)
            {
                myCanvas.width = window.innerHeight;
                myCanvas.height = window.innerHeight*.8;
            }
            else
            {
                myCanvas.width = window.innerWidth;
                myCanvas.height = window.innerWidth*.8;
            }
        }

        north = 0/deg;
        
        DrawAll(context, myCanvas, gpsCoords, north)        
    }

    if (navigator.geolocation) 
    {
        navigator.geolocation.getCurrentPosition(function(position)
        {                
            gpsCoords = position.coords;
            
            resizeCanvasAndDraw();
            
            setInterval(function()
            {
                resizeCanvasAndDraw() 
            }, 60 * 1000); //update every minute
        });
    } 

/*    
    if (window.DeviceOrientationEvent) 
    {
        window.addEventListener('deviceorientation', function(eventData) 
        {
            var north = eventData.alpha;
            
            if (eventData.alpha==null)
                north = 0;

            north += 90;
            
            north = north/deg;
        })
    }
*/    
}
</script>
<body onload="init()">
<div id="frame">
<h1>SunCalc Hemisphere</h1>
<canvas id="myCanvas" width="800" height="600"></canvas>
</div>
</body>
</html>
